##### Автотесты Тестовая среда Конфигурация Продакшен Фреймворк Заглушки

Отчеты -> Allure Report
CI-сервер -> Jenkins
Хранилище артефактов ->GitLab
Тестовый фремворк -> TestNG

Jenkins Pipline
Конфигурирование Jobs
Базовый синтаксис pipline
JOB's на основе pipline
Генераторы фрагментов
Snippet Generator = Плагины для генерации кода Steps
Declarative sections generator
Shared Steps libraries
Логика перезапусков упавших тестов на CI.

##### Создаем и сконфигурируем JOB's в Jenkins
1. Нажать на кнопку Создать. Выбрать задачу со свободной конфигурацией
2. Указать репозиторий, откуда будет выкачиваться код проекта. URL, credentials и branch
3. Добавить нужно параметры : количество потоков и список тестов для запуска
4. Добавить команду для запуска тестов
5. Добавить Allure Report. Добавить путь к артефактам Allure после прогона


- Дожим - перезапуск тестов в рамках одного прогона.
- Перезапуск тестов на более высоком уровне. 
- На уровне CI с помощью Jenkins Pipline. Алгоритм : получаем список упавших тестов и проверяем условия перезапуска. Если упавших тестов нет, завершаем прогон. Если есть, решаем запускать их повторно их или нет.
![[Pasted image 20220724232329.png]]

- Jenkins Pipeline - набор плагинов, позволяющий определить жизненный цикл сборки и доставки приложения как код. Groovy-скрипт с использованием Jenkins Pipeline DSL и хранится стандартно в системе контроля версий. 
- 2 способа описания скриптов : скриптовый и декларативный.
- Для скриптового досточно указать на каком слейве запускать и стадию сборки. И написать Groovy-код для запуска атомарных степов.

-   [https://jenkins.io/doc/book/pipeline/syntax](https://jenkins.io/doc/book/pipeline/syntax)
-   [https://jenkins.io/doc/pipeline/steps/](https://jenkins.io/doc/pipeline/steps/)

##### Знакомства с генераторами фрагментов pipline из UI-интерфейса.
- Snippet Generator — поможет сгенерировать фрагменты шагов. Подсвечивает шаги в зависимости от установленных плагинов. Если есть, Allure-report, то плагин сразу покажет наличие расширения и поможет сгенерировать код
1. Для добавления стадии нужно написать ее имя и указать, что будет внутри(steps).
2. В Sample Step выбрать build: Build a job.
3. Необходимо определить параметры, которые будут переданы в джобу (для примера задано branch, project)
4. Нажать кнопку «Generate» — в результате сформируется готовый рабочий код
5. Изменим параметры джобы на те, которые определили при ее создании.
- threadsCount - кол-во потоков для распараллеливания тестов
- testList - список тестов для запуска
- runId - идентификатор прогона тестов
6. Вставим сгенерированный код степа в пайплайн на следующем шаге.

##### Создаем pipline с помощью Declarative sections generator
Запуск тестов с помощью Pipeline
- Declarative sections generator — генератор фрагментов для декларативного описания пайплайна.
Декларативный pipline нужно указать директивы: 
- pipeline, agent (агент, на котором будет запускаться пайплайн) 
- stages и steps (вставка ранее сгенерированного кода).
![[Pasted image 20220724232505.png]]
1.  В структуре должна быть определена директива pipeline
2. Нужно определить, на каком агенте (agent) будет запущена сборка
3. Дальше идет определение stages, которые будут содержаться в пайплайне, и обязательно должен быть конкретный стейдж с названием stage("name")
4. Обязательно должна быть директива steps, в которой уже содержатся атомарные шаги сборки.
5. Если сборка и стейдж завершились успешно, можно сохранить артефакты или почистить workspace после сборки.

##### Создаем проект pipline
1. New Item -> Pipeline. Нажать на кнопку «Создать проект» и выбрать не джобу со свободной конфигурацией, а джобу Pipeline - указать ей имя 
![[Pasted image 20220724232418.png]]
2. Добавить параметры runId, threadsCount, testList
![[Pasted image 20220724232402.png]]
3. Склонировать из Git. Для version нужно затягивать pipeline из Git. Обязательно указываем путь до скрипта с pipeline.
![[Pasted image 20220724232353.png]]

##### В Jenkins есть встроенный механизм — Многократное использование шагов — Shared Steps
- shared libraries - позволяет описать методы один раз и затем применять их во всех pipeline.
- 2 варианта подключения этой библиотеки :
1. Написанный проект/код подключить через UI Jenkins. Для этого требуются отдельные права на добавление shared libraries
2. Хранить код в отдельном проекте или с pipeline. При использовании этот код подключается как динамическая библиотека и выкачивается каждый раз при запуске pipeline.
Мы используем второй вариант — размещаем shared steps в проекте с pipeline.
1. Создать папку var
2. В ней создать файл с названием метода, который планируется запускать — gradlew.groovy
3. Стандартно определить имя метода (должен называться call), то есть написать «def call» и определить входящие параметры
4. В теле метода можно написать произвольный Groovy-код и/или Pipeline-степы.
5. Pipeline script : ![[Pasted image 20220724233625.png]]
var/gradlew.groovy : ![[Pasted image 20220724233641.png]]

Вынесение запуска тестов в shared steps в /var
1. Выносим startTests.groovy в /var.
- Нужно вынести запуск тестов в отдельный метод. 
- Создаем файл, называем метод def call
- Берем кусок кода, который был в пайплайне, и выносим его в этот step.
![[Pasted image 20220724234115.png]]
- Для передачи параметров используется Map<String, String>
2.  Подключение shared steps как внешней библиотеки.
- Нужно добавить вынесенные шаги в pipeline. 
- При динамической подгрузке библиотек (во время запуска пайплайна) 
- Шаги выкачиваются из репозитория и подключаются на лету.
- Сделать это можно с помощью сниппет-генератора 
- выбираем степ library и указываем ветку, в которую все будет собираться и репозиторий. 
- Нажимаем кнопку «Сгенерировать» и вставляем получившийся pipeline.
![[Pasted image 20220724234658.png]]
![[Pasted image 20220724234713.png]]
- Теперь после подключения shared steps вместо шага запуска тестов build нужно вставить startTest. Не забудьте, что имя метода должно совпадать с именем файла.
![[Pasted image 20220724234828.png]]






